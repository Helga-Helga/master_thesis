\chapter{Попередні роботи присвячені задачі стереобачення}

В першому розділі надано стислий огляд досліджень,
що пов'язані із задачею стереобачення.
Проводиться аналіз та порівняння деяких існуючих методів розв'язання задачі.
Розбір попередніх робіт дає змогу виявити недоліки
існуючих рішень та чітко поставити задачу,
що розв'язується в другому та третьому розділах дисертації.

\section{Динамічне програмування}

Вважається, що камера не вносить радіальних спотворень,
а два зображення отримуються шляхом її ідеального зсуву по горизонталі,
тобто пікселям рядка $y$ лівого зображення
$L_y \; : \; \left\{ 1, \dotsc, width \right\} \to C$
відповідають пікселі рядка $y$
правого зображення $R_y \; : \; \left\{ 1, \dotsc, width \right\} \to C$,
де $y = \overline{1, height}$, а $C$~---~множина, що задає кольори
(або інтенсивності) пікселів.
Вважається, що в кожен рядок лівого зображення проектується свій об'єкт,
тому вектори зсувів для всіх рядків можна знаходити окремо шляхом
мінімізації штрафної функції
\begin{equation}\label{eq:overview:energy}
    E \left(d, y \right)
    = \sum \limits_{x = 1}^{width}
        f \left(
            L \left(y, x \right),
            R \left( y, x - d \left(x \right) \right)
        \right)
    + \sum \limits_{x = 1}^{width}
        g \left(d \left(x \right), d \left( x + 1 \right) \right),
\end{equation}
яка називається енергією, де $d$~---~вектор зсувів для рядка з номером $y$.
Штрафна функція включає штраф за негладкість карти зсувів $g$ (бінарні штрафи)
і невідповідність кольорів співставлених пікселів на двох зображеннях $f$
(унарні штрафи).
Унарні штрафи $f$ залежать
лише від значення інтенсивності в даному пікселі та вибраного для нього зсуву,
бінарні штрафи $g$~---~від зсувів двох сусідніх по горизонталі пікселів.

Для кожного рядка зображення будується граф,
де кожен піксель $x$ рядка $y$ є об'єктом,
а вершини в об'єктах відповідають можливим зсувам $d \left(x \right)$.
Назвемо їх мітками.
Сусідніми вважаються лише ті об'єкти, які відповідають сусіднім пікселям
(у кожного пікселя є лівий і правий сусідні пікселі).
Вага мітки в об'єкті $x$, що відповідає зсуву $d \left(x \right)$,
задається значенням функції
$f \left(
    L \left(y, x \right),
    R \left( y, x - d \left(x \right) \right)
\right)$,
а вага дужки між двома сусідніми об'єктами $x$ і $x + 1$~---~значенням функції
$g \left(d \left(x \right), d \left( x + 1 \right) \right)$.
Методом динамічного програмування знаходится
такий вектор зсувів для кожного рядка,
що відповідає найкоротшому шляху на побудованому графі
\cite{overview:cox:dynamic}.

\begin{figure}[h]
  \centering
  \begin{subfigure}[b]{0.8\textwidth}
      \includegraphics[width=\textwidth]{images/overview_cox_dynamic_left_right}
      \caption{Ліве та праве зображення}
  \end{subfigure}
  \begin{subfigure}[b]{0.4\textwidth}
      \includegraphics[width=\textwidth]{images/overview_cox_dynamic_result}
      \caption{Карта глибин}
  \end{subfigure}
  \caption{Результати, отримані методом динамічного програмування
           (зображення взяті зі статті \cite{overview:cox:dynamic})}
  \label{fig:overview:cox:dynamic}
\end{figure}

Недолiком методу динамiчного програмування є те, що вiн обробляє всi
рядки зображення незалежно, тобто не враховує узгодженості між рядками,
тому в простому випадку метод динамічного програмування не використовує
двовимірність задачі та не дає гладкої карти
глибин по вертикалі (рис. \ref{fig:overview:cox:dynamic}).
Водночас, алгоритм працює досить швидко,
а результати можна значно покращити (рис. \ref{fig:overview:wang:dynamic}),
наприклад розглядаючи вісім сусідів пікселя
замість двох та використовуючи сегментацію зображення за кольором
\cite{overview:wang:dynamic}.

\begin{figure}[h]
  \centering
  \includegraphics[width=0.8\textwidth]{images/overview_wang_dynamic}
  \caption{Результати, отримані за допомогою покращеного методу динамічного
           програмування
           (зображення взяті зі статті \cite{overview:wang:dynamic})}
  \label{fig:overview:wang:dynamic}
\end{figure}

\section{Нейронні мережі}

Нейронна мережа навчається на вхідних даних:
парах зображень та відповідній ним карті глибин.
Добре розмічені вхідні дані для навчання
наявні для зображень дороги.
Нейронна мережа, навчена на таких даних може давати погані результати для
зображень іншого середовища.
На рисунку \ref{fig:overview:luo:nn}
наведено приклад вхідних даних і результуючої карти глибин,
що була навчена за допомогою даних з набору <<KITTI Stereo>>
\cite{overview:geiger:nn}.

\begin{figure}[h]
  \centering
  \includegraphics[width=\textwidth]{images/overview_luo_nn}
  \caption{Ліве зображення та карта глибин,
           отримана за допомогою нейронної мережі
           (зображення взяті зі статті \cite{overview:luo:nn})}
  \label{fig:overview:luo:nn}
\end{figure}

\section{Знаходження мінімального розрізу графа}

Задачею є мінімазація енергії \ref{eq:overview:energy}.
Будується граф-решітка, у якому вершинами є всі пікселі зображення.
Назвемо ці вершини основними.
Ваги вершин і дуг задаються як в методі динамічного програмування.
До графа додається дві допоміжні вершнии: джерело та стік,
які поєднуються з кожними іншими вершинами графу.
Кожній основній вершині має бути поставлена у відповідність
мітка~---~значення зсуву координати пікселя по відношенню до цієї ж координати
на іншому зображенні зі стереопари.
Застосовується алгоритм $\alpha$-експансії:
спочатку фіксується якась мітка в кожній основній вершині.
Також випадковим чином обирається ще одна мітка (однакова для всіх вершин).
Шляхом знаходження мінімального розрізу графу,
в якому дужки направлені та йдуть від джерела до стоку,
в кожній вершині обирається одна з двох міток.
Обрані мітки подаються на вхід алгоритму на наступній ітерації.
Результати, отримані за допомогою такого методу,
представлені на рисунку \ref{fig:overview:kolmogorov:graphcut}.

\begin{figure}[h]
  \centering
  \includegraphics[width=0.8\textwidth]{images/overview_kolmogorov_graphcut}
  \caption{Ліве зображення та карта глибин,
           отримана за допомогою знаходження мінімального розрізу графу
           (зображення взяті зі статті \cite{overview:kolmogorov:graphcut})}
  \label{fig:overview:kolmogorov:graphcut}
\end{figure}

Для більш швидкої глобальної оптимізації
виконують сегментацію одного із зображень стереопари.
На пікселі в одному сегменті накладаютсья обмеження на зсуви так,
що при глобальній оптимізації оновлюється декілька змінних одразу
\cite{overview:ferg:graphcut}.

\section{Алгоритм дифузії}

Будується граф-решітка та мінімізується енергія \ref{eq:overview:energy}
шляхом розв'язання двоїстої задачі \cite{overview:savchynskyy:diffusion}.
Докладніше алгоритм описано в наступному розділі.

\section{Постановка задачі}

Виходячи з аналізу статей, запишемо постановку задачі,
яка буде розв'язана в наступних розділах.

Задане ліве півтонове зображення $L : T \to C$
та праве півтонове зображення $R : T \to C$
де
$T = \left\{
    \left( x, y \right) \; \middle| \; 1 \le x \le w, q \le y \le h
\right\}$~---~множина координат пікселів зображення,
$w$~---~ширина зображення (кількість пікселів по горизонталі),
$h$~---~висота зображення (кількість пікселів по вертикалі),
$C = \left\{ 0, 255 \right\} $~---~множина інтенсивностей пікселів.
Таким чином,
$L \left(x, y \right)$~---~це інтенсивність пікселя лівого зображення
з координатою $x$ по горизонталі та координатою $y$ по вертикалі,
а $R \left( x, y \right)$~---~це інтенсивність пікселя правого зображення
з координатою $x$ по горизонталі та координатою $y$ по вертикалі.

Вважається, що $L$ і $R$~---~пара зображень нерухомої сцени,
що зняті одніїю й тією ж камерою.
При цьому, праве зображення $R$ було отримано при тому ж напрямку зйомки,
що й ліве зображення $L$, але при зсуві камери строго горизонтально праворуч.
Це означає,
що проекції об'єктів на зображення також зміщуються виключно горизонтально.
Будуємо таку модель, згідно якої об'єкти не перекриваються один одним.
В експериментах, що наведені в четвертому розділі дисертації, показано,
що це не сильно обмежує застосування алгоритму~---~на практиці його можна
використовувати й для об'єктів, які перекриваються.

% TODO: image of two cameras and some simple object

Таким чином, рядок з вертикальною координатою $y$
на лівому зображенні відповідає
рядку з вертикальною координатою $y$ на правому зображенні.
За рахунок паралаксу горизонтальна координата $x$
кожного пікселя лівого зображення $\left( x, y \right) \in T$
зсувається вліво на величину $d \left(x, y \right) $
для отримання координати відповідного пікселя на правому зображенні
$\left( x - d \left(x, y \right), y \right)$.
Множина всіх можливих зсувів горизонтальної координати пікселя дорівнює
$D = \left\{ 0, \dotsc, M \right\}$, де $M$~---~фіксований максимальний зсув.

Розглянемо задачу стереобачення в двовимірному світі,
де точки простору описуються двома невідомими координатами
$ \left( x, z \right) $ (рис.~\ref{fig:geometry}).
Задача полягає в знаходженні координати $z$,
яка визначає висоту точок в просторі,
для всіх пікселів на одному з зображень,
знятих камерою.
$C_1$~---~точка фокусу камери в першому положенні.
Вважаємо, що в ній знаходиться початок координат.
$C_2$~---~точка фокусу камери після зсуву її по горизонталі на відстань $b$.
Двома горизонтальними лініями позначені плівки, або площини,
на яких формуються зображення.
$f$~---~фокусна відстань камери~---~відстань від точки фокуса камери до плівки.
$x_1$ та $x_2$ позначають відстані від центрів зображень до променів,
що йдуть від точкок фокуса камери в двох положеннях до точки в прострорі.

\begin{figure}[h]
  \centering
  \includegraphics[width=0.8\textwidth]{images/2d_geometry}
  \caption{Одна точка простору, сфотографована камерою з двох положень}
  \label{fig:geometry}
\end{figure}

З подібності трикутників $\triangle BXC_1$ та $\triangle C_1 F_1 P_1$
(рис.~\ref{fig:triangles}) має місце співвідношення
\begin{equation}
    \frac{x}{z} = \frac{x_1}{f}.
\end{equation} \label{triangle:1}
З подібності трикутників $\triangle BXC_2$ та $\triangle C_2 F_2 P_2$
(рис.~\ref{fig:triangles}) має місце співвідношення
\begin{equation} \label{triangle:2}
    \frac{x - b}{z} = \frac{x_2}{f}.
\end{equation}

\begin{figure}[h]
  \centering
  \includegraphics[width=0.8\textwidth]{images/2d_triangles}
  \caption{Подібні трикутники}
  \label{fig:triangles}
\end{figure}

Віднімемо співвідношення \eqref{triangle:2} від співвідношення
\eqref{triangle:1}
\begin{equation*}
    \frac{b}{z} = \frac{x_1 - x_2}{f},
\end{equation*}
звідки шукане значення координати $z$ дорівнює
\begin{equation*}
    z = \frac{b \cdot f}{x_1 - x_2} = \frac{b \cdot f}{d}.
\end{equation*}
Таким чином, щоб знайти положення точки в просторі,
необхідно знайти значення паралаксу $d$,
а також знати фокусну відстань камери $f$ та відстань,
на яку камера була зсунута по горизонталі $b$.

% TODO: two images with horizontal line showing one shifted point

Далі розглядається задача пошуку значення паралаксу для всіх пікселів
лівого зображення $L$, тобто задача пошук карти глибин.

Будується $\left| T \right|$-дольний граф-решітка,
де кожній долі відповідає один піксель (рис.~\ref{fig:grid:graph:pixels}).
Будемо називати долі графу об'єктами.

\begin{figure}[h]
  \centering
  \includegraphics[width=0.6\textwidth]{images/grid_graph_pixels}
  \caption{$\left|T \right|$-дольний граф-решітка}
  \label{fig:grid:graph:pixels}
\end{figure}


Кожен об'єкт $\left(y, x \right) \in T$ має $\left| D \right| $ вершин
$ \left( x, y, d \right)$,
які відповідають всім можливим зсувам $d \in D$ пікселя $\left(x, y \right)$.
Значення зсувів $d \in D$ будемо називати мітками.

На кожну вершину $\left(x, y, d \right), \, d \in D$ в кожній долі графу
$\left(x, y \right) \in T$
накладається штраф за невідповідність інтенсивностей відповідних пикселів
\begin{equation*}
    f_{\left(x, y \right)} \left(d \right) =
    f \left(
        L \left(x, y\right),
        R \left(x - d, y \right)
    \right).
\end{equation*}

Кожен об'єкт графу має не більше чотирьох сусідніх об'єктів: верхній, правий,
нижній і лівий.
Об'єкти, що відповідають пікселям на границях зображення, мають по три сусіда,
а об'єкти, що відповідають кутовим пікселям,~---~по два.
Нехай $\mathcal{N} \left( x, y \right) $~---~множина всіх
сусідніх об'єктів для об'єкта $\left( x, y \right)$.
Всі вершини кожного об'єкту поєднані дужками з усіма
вершинами в сусідніх об'єктах.
% TODO: add image for illustration of edges between nodes
На дужку між вершиною з міткою $d \in D$ в об'єкті $\left(x, y \right)$
і вершиною з міткою $d' \in D$ в об'єкті $\left(x', y' \right)$
накладається штраф за невідповідність обраних зсувів в сусідніх об'єктах
$g_{\left(x, y \right), \left(x', y' \right)} \left(d, d' \right)$.
Множину всіх сусідніх об'єктів позначимо через $\mathcal{N}$.

Відображення $\pmb{d} : T \rightarrow D$ назвемо розміткою.
Кожному пікселю зображення (кожному об'єкту графу)
воно ставить у відповідність мітку,
тобто обирає одну й тільки одну вершину в кожному об'єкті.
% TODO: add image for illustration of labeling
Задача полягає в такому виборі розмітки $\pmb{d} \in D^T$,
яка мінімізує штрафну функцію
\begin{equation} \label{eq:overview:penalty}
\begin{gathered}
    E \left( \overline{d} \right)
    = \sum \limits_{x = 1}^{w}
        \sum \limits_{y = 1}^{h}
            f_{\left(x, y \right)} \left(d \left(x, y \right) \right) + \\
    + \sum \limits_{x = 1}^{w}
        \sum \limits_{y = 1}^{h}
            \sum \limits_{\left( x', y' \right) \in \mathcal{N} \left( x, y \right)}
            g_{\left(x, y \right), \left(x', y' \right)} \left(
                d \left( x, y \right), d \left( x', y' \right)
            \right).
\end{gathered}
\end{equation}

\section*{Висновки до розділу 1}
\addcontentsline{toc}{section}{Висновки до розділу 1}

Проведено огляд алгоритмів,
які використовуються для розв'язання задачі стереобачення.
Поставлена задача,
розв'язання якої наведено в наступних роздiлах дисертації.
